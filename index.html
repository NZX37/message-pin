<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1.0, width=device-width">
  <title>Message Board</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .auth-container, .app-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    h2 {
      color: #555;
      margin: 20px 0 15px 0;
      font-size: 1.3em;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95em;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
    
    input[type="text"], input[type="password"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .toggle-auth {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }
    
    .toggle-auth a {
      color: #667eea;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
    }
    
    .toggle-auth a:hover {
      text-decoration: underline;
    }
    
    .message {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .username {
      font-weight: 700;
      color: #667eea;
      font-size: 0.95em;
    }
    
    .timestamp {
      font-size: 0.85em;
      color: #999;
    }
    
    .message-text {
      color: #333;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .user-info {
      background: #f0f0f0;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info span {
      color: #555;
      font-weight: 500;
    }
    
    .logout-btn {
      background: #dc3545;
      padding: 6px 12px;
      font-size: 0.9em;
      width: auto;
      margin: 0;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .messages-container {
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c00;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Login/Register Page -->
  <div id="authPage" class="auth-container">
    <h1>Message Board</h1>
    <p class="subtitle">Connect and share messages with others</p>
    
    <div id="errorMsg" class="error hidden"></div>
    
    <div id="loginForm">
      <h2>Login</h2>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="loginUsername" placeholder="Enter your username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password">
      </div>
      <button onclick="login()">Login</button>
      <div class="toggle-auth">
        Don't have an account? <a onclick="showRegister()">Register here</a>
      </div>
    </div>
    
    <div id="registerForm" class="hidden">
      <h2>Register</h2>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="regUsername" placeholder="Choose a username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="regPassword" placeholder="Choose a password">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="regPasswordConfirm" placeholder="Confirm your password">
      </div>
      <button onclick="register()">Register</button>
      <div class="toggle-auth">
        Already have an account? <a onclick="showLogin()">Login here</a>
      </div>
    </div>
  </div>

  <!-- Main App Page -->
  <div id="appPage" class="app-container hidden">
    <h1>Message Board</h1>
    
    <div class="user-info">
      <span>Logged in as: <strong id="currentUser"></strong></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <h2>Post a Message</h2>
    <div class="form-group">
      <textarea id="messageText" placeholder="What's on your mind?"></textarea>
    </div>
    <button id="submitBtn" onclick="submitMessage()">Post Message</button>
    
    <h2>Messages</h2>
    <div class="messages-container" id="messagesContainer"></div>
  </div>

  <script>
    const scriptURL = "https://script.googleusercontent.com/a/macros/students.edu.sg/echo?user_content_key=AehSKLj3zVvp8Aj-B8S9ovtnSubgOvjmE_ODdhRSUORuKW6afUUFHV5pLfT6Cy0LfO_iGMcc3vMiQBrfX9oFrOPb0h6meCbIEwJkRPUUMPoURu0ORTcRLtqQJBk4wJS7rzTwAP-cDa6gDGC4FNFCmjeBlr0mU99Tn7wJ4eOAHk88_ChP7AISJYJaGTnxj6Q0LFNoGK38hYaz4Llj3Yt-c_uNBC1pAyvrqfASUIc_5IITnStEPBzx0Q6xmYhDPYxNtjeW1w0L5Kb06rwtvkDIw5pR243NX6btWGY7iQd48xNHaf-fXuBvJmqehqRnTv9VTQ&lib=Mbc0dRXJnZBhW_-IJ34sVdnVB3wKfOYCY";
    let currentUsername = null;

    // Check if user is already logged in
    window.onload = function() {
      const savedUser = localStorage.getItem('username');
      if (savedUser) {
        currentUsername = savedUser;
        showApp();
        loadMessages();
      }
    };

    function showError(message) {
      const errorDiv = document.getElementById('errorMsg');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }

    function showLogin() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
    }

    function showRegister() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showApp() {
      document.getElementById('authPage').classList.add('hidden');
      document.getElementById('appPage').classList.remove('hidden');
      document.getElementById('currentUser').textContent = currentUsername;
    }

    function showAuth() {
      document.getElementById('authPage').classList.remove('hidden');
      document.getElementById('appPage').classList.add('hidden');
    }

    async function register() {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;

      if (!username || !password) {
        showError('Please fill in all fields');
        return;
      }

      if (password !== passwordConfirm) {
        showError('Passwords do not match');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      try {
        const response = await fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams({
            action: 'register',
            username: username,
            password: password
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentUsername = username;
          localStorage.setItem('username', username);
          showApp();
          loadMessages();
          
          // Clear form
          document.getElementById('regUsername').value = '';
          document.getElementById('regPassword').value = '';
          document.getElementById('regPasswordConfirm').value = '';
        } else {
          showError(result.message || 'Registration failed');
        }
      } catch (error) {
        showError('Network error. Please try again.');
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showError('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams({
            action: 'login',
            username: username,
            password: password
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentUsername = username;
          localStorage.setItem('username', username);
          showApp();
          loadMessages();
          
          // Clear form
          document.getElementById('loginUsername').value = '';
          document.getElementById('loginPassword').value = '';
        } else {
          showError(result.message || 'Invalid username or password');
        }
      } catch (error) {
        showError('Network error. Please try again.');
      }
    }

    function logout() {
      currentUsername = null;
      localStorage.removeItem('username');
      showAuth();
      showLogin();
    }

    async function submitMessage() {
      const messageText = document.getElementById('messageText').value.trim();
      
      if (!messageText) {
        alert('Please enter a message');
        return;
      }

      const button = document.getElementById('submitBtn');
      button.disabled = true;
      button.textContent = 'Posting...';

      try {
        await fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams({
            action: 'postMessage',
            username: currentUsername,
            message: messageText
          })
        });

        document.getElementById('messageText').value = '';
        loadMessages();
      } catch (error) {
        alert('Failed to post message');
      } finally {
        button.disabled = false;
        button.textContent = 'Post Message';
      }
    }

    async function loadMessages() {
      try {
        const response = await fetch(scriptURL + '?action=getMessages');
        const messages = await response.json();

        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        if (!messages || messages.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No messages yet. Be the first to post!</p>';
          return;
        }

        messages.reverse().forEach(msg => {
          if (!msg.message || !msg.username) return;

          const div = document.createElement('div');
          div.className = 'message';

          const header = document.createElement('div');
          header.className = 'message-header';

          const usernameSpan = document.createElement('span');
          usernameSpan.className = 'username';
          usernameSpan.textContent = msg.username;

          const timestampSpan = document.createElement('span');
          timestampSpan.className = 'timestamp';
          if (msg.timestamp) {
            const date = new Date(msg.timestamp);
            timestampSpan.textContent = date.toLocaleString();
          }

          header.appendChild(usernameSpan);
          header.appendChild(timestampSpan);

          const messageText = document.createElement('div');
          messageText.className = 'message-text';
          messageText.textContent = msg.message;

          div.appendChild(header);
          div.appendChild(messageText);
          container.appendChild(div);
        });
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }

    // Refresh messages every 10 seconds
    setInterval(() => {
      if (currentUsername) {
        loadMessages();
      }
    }, 10000);
  </script>
</body>
</html>
